<form 
  method="POST"
  enctype="multipart/form-data"
  class="max-w-[95dvw] w-[570px] mx-auto mt-30"
  id="contact-form"
>
  <h2 class="text-3xl font-bold text-center mb-3">CONTÁCTANOS</h2>

  <div class="mb-4">
    <label class="block text-lg font-semibold mb-2" for="name">
      Nombre
    </label>
    <input
      class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none"
      id="name"
      type="text"
      name="name"
      required
    />
  </div>

  <div class="mb-4">
    <label class="block text-lg font-semibold mb-2" for="email">
      Correo electrónico
    </label>
    <input
      class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none"
      id="email"
      type="email"
      name="email"
      required
    />
  </div>

  <div class="mb-3">
    <label class="block text-lg font-semibold mb-2" for="message">
      Mensaje
    </label>
    <textarea
      class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none"
      id="message"
      name="message"
      rows="5"
      required
    ></textarea>
  </div>

  <label for="cbx" class="flex gap-2">
    <div class="perspective-20 rounded cursor-pointer transition-all duration-300 ease-in-out">
      <input id="cbx" type="checkbox" class="hidden peer" />
      <div class="relative w-5 h-5 preserve-3d transition-all duration-400 ease-in-out peer-checked:rotate-y-180">
        <div class="absolute top-0 left-0 w-5 h-5 rounded-sm bg-white z-10 backface-hidden"></div>
        <div class="absolute top-0 left-0 w-5 h-5 rounded-sm bg-primary text-white text-center leading-5 shadow-[0_0_0_1px_#0b76ef] rotate-y-180 backface-hidden">
          <svg viewBox="0 0 16 14" height="14" width="16" class="mx-auto mt-[3px] fill-none">
            <path d="M2 8.5L6 12.5L14 1.5" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>

    <span>
      Estoy de acuerdo con la <a href="/privacidad" class="underline">Política de Privacidad</a>.
    </span>
  </label>

  <div class="flex justify-end mt-3">
    <button
      class="
        bg-primary/70 hover:bg-secondary/70 font-bold py-2 px-6 rounded focus:outline-none transition-all duration-200 cursor-pointer grow
        disabled:opacity-40 disabled:cursor-not-allowed
      "
      type="submit"
      id="contact-form-submit-button"
      disabled
    >
      Enviar
    </button>
  </div>
</form>

<style>
  .perspective-20 {
    perspective: 20px;
  }
  .preserve-3d {
    transform-style: preserve-3d;
  }
  .rotate-y-180 {
    transform: rotateY(180deg);
  }
  .backface-hidden {
    backface-visibility: hidden;
  }
</style>

<script>
  import { actions } from "astro:actions";

  const submitButton = document.querySelector("#contact-form-submit-button") as HTMLButtonElement;
  const checkbox = document.querySelector("#cbx") as HTMLInputElement;

  checkbox.addEventListener("change", () => {
    submitButton.disabled = !checkbox.checked;
  });
  
  const form = document.getElementById("contact-form") as HTMLFormElement;
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!e.target) {
      return;
    }

    const formData = new FormData(e.target as HTMLFormElement);
    const { data, error } = await actions.contact(formData);
    if (error) {
      alert(error);
      return;
    }

    showToast("Tu mensaje ha sido enviado con éxito. Te responderemos lo antes posible.");
    form.reset();
    return false;
  });

  function showToast(message = "Operación exitosa", type = "success") {
    const toast = document.createElement('div');

    toast.textContent = message;
    toast.className = `toast toast-${type}`;

    Object.assign(toast.style, {
      position: 'fixed',
      bottom: '30px',
      right: '30px',
      backgroundColor: type === 'success' ? '#4caf50' : '#f44336',
      color: '#fff',
      padding: '12px 20px',
      borderRadius: '4px',
      boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
      zIndex: 9999,
      opacity: 1,
      transition: 'opacity 0.5s ease'
    });

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
    }, 4500);

    setTimeout(() => {
      toast.remove();
    }, 5000);
  }
</script>